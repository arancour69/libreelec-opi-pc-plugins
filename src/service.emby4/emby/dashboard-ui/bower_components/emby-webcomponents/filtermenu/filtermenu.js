define(["require","dom","focusManager","dialogHelper","loading","apphost","inputManager","layoutManager","connectionManager","appRouter","globalize","userSettings","emby-checkbox","emby-input","emby-select","paper-icon-button-light","emby-select","material-icons","css!./../formdialog","emby-button","emby-linkbutton","flexStyles"],function(require,dom,focusManager,dialogHelper,loading,appHost,inputManager,layoutManager,connectionManager,appRouter,globalize,userSettings){"use strict";function onSubmit(e){return e.preventDefault(),!1}function renderList(container,items,options,property,delimeter){var anySelected=!1,value=options.settings[property],html=items.map(function(i){var itemId=i.Id||i.Name,selected=-1!==(delimeter+(value||"")+delimeter).indexOf(delimeter+itemId+delimeter),selectedHtml=selected&&!anySelected?" selected":"";return selected&&(anySelected=!0),'<option value="'+itemId+'"'+selectedHtml+">"+i.Name+"</option>"}).join(""),allText=globalize.translate("All"),prefix=anySelected?'<option value="">'+allText+"</option>":'<option value="" selected>'+allText+"</option>";container.querySelector("select").innerHTML=prefix+html,items.length?container.classList.remove("hide"):container.classList.add("hide")}function loadPlayState(context,options){var anySelected=!1,menuItems=[];-1!==options.visibleSettings.indexOf("IsPlayed")&&menuItems.push({name:globalize.translate("Played"),value:"IsPlayed"}),-1!==options.visibleSettings.indexOf("IsUnplayed")&&menuItems.push({name:globalize.translate("Unplayed"),value:"IsUnplayed"}),-1!==options.visibleSettings.indexOf("IsResumable")&&menuItems.push({name:globalize.translate("ContinuePlaying"),value:"IsResumable"});var html=menuItems.map(function(m){var optionSelected=!anySelected&&(options.settings[m.value]||!1),selectedHtml="";return optionSelected&&(anySelected=!0,selectedHtml=" selected"),'<option value="'+m.value+'" '+selectedHtml+">"+m.name+"</option>"}).join(""),allText=globalize.translate("All"),prefix=anySelected?'<option value="">'+allText+"</option>":'<option value="" selected>'+allText+"</option>";context.querySelector(".selectPlaystate").innerHTML=prefix+html,menuItems.length?context.querySelector(".playstateFilters").classList.remove("hide"):context.querySelector(".playstateFilters").classList.add("hide")}function handleQueryError(){}function loadGenres(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getGenres(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".genreFilters"),result.Items,options,"GenreIds",",")},handleQueryError)}function loadStudios(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getStudios(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".studioFilters"),result.Items,options,"StudioIds",",")},handleQueryError)}function loadOfficialRatings(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getOfficialRatings(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".officialRatingFilters"),result.Items,options,"OfficialRatings","|")},handleQueryError)}function loadTags(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getTags(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".tagFilters"),result.Items,options,"Tags","|")},handleQueryError)}function loadYears(context,options){var apiClient=connectionManager.getApiClient(options.serverId);if(!apiClient.isMinServerVersion("3.6.0.53"))return Promise.resolve();var query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getYears(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".yearFilters"),result.Items,options,"Years",",")},handleQueryError)}function loadContainers(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getContainers(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".containerFilters"),result.Items,options,"Containers",",")},handleQueryError)}function loadAudioCodecs(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getAudioCodecs(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".audioCodecFilters"),result.Items,options,"AudioCodecs",",")},handleQueryError)}function loadVideoCodecs(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getVideoCodecs(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".videoCodecFilters"),result.Items,options,"VideoCodecs",",")},handleQueryError)}function loadSubtitleCodecs(context,options){var apiClient=connectionManager.getApiClient(options.serverId),query=Object.assign(options.filterMenuOptions,{SortBy:"SortName",SortOrder:"Ascending",Recursive:null==options.Recursive||options.Recursive,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1,GenreIds:options.GenreIds,PersonIds:options.PersonIds,StudioIds:options.StudioIds,ParentId:options.parentId,IncludeItemTypes:options.itemTypes.join(",")});apiClient.getSubtitleCodecs(apiClient.getCurrentUserId(),query).then(function(result){renderList(context.querySelector(".subtitleCodecFilters"),result.Items,options,"SubtitleCodecs",",")},handleQueryError)}function initEditor(context,settings){context.querySelector("form").addEventListener("submit",onSubmit);var i,length,elems=context.querySelectorAll(".simpleFilter");for(i=0,length=elems.length;i<length;i++)"INPUT"===elems[i].tagName?elems[i].checked=settings[elems[i].getAttribute("data-settingname")]||!1:elems[i].querySelector("input").checked=settings[elems[i].getAttribute("data-settingname")]||!1;var seriesStatuses=settings.SeriesStatus?settings.SeriesStatus.split(","):[];for(elems=context.querySelectorAll(".chkSeriesStatus"),i=0,length=elems.length;i<length;i++)elems[i].checked=-1!==seriesStatuses.indexOf(elems[i].getAttribute("data-filter"));context.querySelector(".basicFilterSection .viewSetting:not(.hide)")?context.querySelector(".basicFilterSection").classList.remove("hide"):context.querySelector(".basicFilterSection").classList.add("hide"),context.querySelector(".featureSection .viewSetting:not(.hide)")?context.querySelector(".featureSection").classList.remove("hide"):context.querySelector(".featureSection").classList.add("hide")}function saveValues(context,settings,settingsKey){var i,length,elems=context.querySelectorAll(".simpleFilter");for(i=0,length=elems.length;i<length;i++)"INPUT"===elems[i].tagName?setBasicFilter(context,settingsKey+"-filter-"+elems[i].getAttribute("data-settingname"),elems[i]):setBasicFilter(context,settingsKey+"-filter-"+elems[i].getAttribute("data-settingname"),elems[i].querySelector("input"));var seriesStatuses=[];for(elems=context.querySelectorAll(".chkSeriesStatus"),i=0,length=elems.length;i<length;i++)elems[i].checked&&seriesStatuses.push(elems[i].getAttribute("data-filter"));userSettings.setFilter(settingsKey+"-filter-SeriesStatus",seriesStatuses.join(","));var genres=[],elem=context.querySelector(".selectGenre");elem.value&&genres.push(elem.value),userSettings.setFilter(settingsKey+"-filter-GenreIds",genres.join(","));var studios=[];elem=context.querySelector(".selectStudio"),elem.value&&studios.push(elem.value),userSettings.setFilter(settingsKey+"-filter-StudioIds",studios.join(","));var tags=[];elem=context.querySelector(".selectTags"),elem.value&&tags.push(elem.value),userSettings.setFilter(settingsKey+"-filter-Tags",tags.join("|"));var containers=[];elem=context.querySelector(".selectContainers"),elem.value&&containers.push(elem.value),userSettings.setFilter(settingsKey+"-filter-Containers",containers.join(","));var codecs=[];elem=context.querySelector(".selectAudioCodecs"),elem.value&&codecs.push(elem.value),userSettings.setFilter(settingsKey+"-filter-AudioCodecs",codecs.join(",")),codecs=[],elem=context.querySelector(".selectVideoCodecs"),elem.value&&codecs.push(elem.value),userSettings.setFilter(settingsKey+"-filter-VideoCodecs",codecs.join(",")),codecs=[],elem=context.querySelector(".selectSubtitleCodecs"),elem.value&&codecs.push(elem.value),userSettings.setFilter(settingsKey+"-filter-SubtitleCodecs",codecs.join(","));var years=[];elem=context.querySelector(".selectYears"),elem.value&&years.push(elem.value),userSettings.setFilter(settingsKey+"-filter-Years",years.join(","));var OfficialRatings=[];elem=context.querySelector(".selectOfficialRating"),elem.value&&OfficialRatings.push(elem.value),userSettings.setFilter(settingsKey+"-filter-OfficialRatings",OfficialRatings.join("|")),setPlaystateFilters(context,settingsKey)}function setPlaystateFilters(context,settingsKey){for(var selectPlaystate=context.querySelector(".selectPlaystate"),options=selectPlaystate.options,value=selectPlaystate.value,i=0,length=options.length;i<length;i++){var optionValue=options[i].value;optionValue===value?optionValue&&userSettings.setFilter(settingsKey+"-filter-"+optionValue,!0):optionValue&&userSettings.setFilter(settingsKey+"-filter-"+optionValue,null)}}function setBasicFilter(context,key,elem){var value=elem.checked;value=value||null,userSettings.setFilter(key,value)}function centerFocus(elem,horiz,on){require(["scrollHelper"],function(scrollHelper){var fn=on?"on":"off";scrollHelper.centerFocus[fn](elem,horiz)})}function moveCheckboxFocus(elem,offset){for(var parent=dom.parentWithClass(elem,"checkboxList-verticalwrap"),elems=focusManager.getFocusableElements(parent),index=-1,i=0,length=elems.length;i<length;i++)if(elems[i]===elem){index=i;break}index+=offset,index=Math.min(elems.length-1,index),index=Math.max(0,index);var newElem=elems[index];newElem&&focusManager.focus(newElem)}function onInputCommand(e){switch(e.detail.command){case"left":moveCheckboxFocus(e.target,-1),e.preventDefault();break;case"right":moveCheckboxFocus(e.target,1),e.preventDefault()}}function FilterMenu(){}function bindCheckboxInput(context,on){for(var elems=context.querySelectorAll(".checkboxList-verticalwrap"),i=0,length=elems.length;i<length;i++)on?inputManager.on(elems[i],onInputCommand):inputManager.off(elems[i],onInputCommand)}return FilterMenu.prototype.show=function(options){return new Promise(function(resolve,reject){require(["text!./filtermenu.template.html"],function(template){var dialogOptions={removeOnClose:!0,scrollY:!1};layoutManager.tv?dialogOptions.size="fullscreen":dialogOptions.size="small";var dlg=dialogHelper.createDialog(dialogOptions);dlg.classList.add("formDialog");var html="";html+='<div class="formDialogHeader">',html+='<button is="paper-icon-button-light" class="btnCancel hide-mouse-idle-tv" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>',html+='<h3 class="formDialogHeaderTitle">${Filters}</h3>',html+="</div>",html+=template,dlg.innerHTML=globalize.translateDocument(html,"sharedcomponents");for(var settingElements=dlg.querySelectorAll(".viewSetting"),i=0,length=settingElements.length;i<length;i++)-1===options.visibleSettings.indexOf(settingElements[i].getAttribute("data-settingname"))?settingElements[i].classList.add("hide"):settingElements[i].classList.remove("hide");initEditor(dlg,options.settings),loadPlayState(dlg,options),-1!==options.visibleSettings.indexOf("Genres")&&loadGenres(dlg,options),-1!==options.visibleSettings.indexOf("Studios")&&loadStudios(dlg,options),-1!==options.visibleSettings.indexOf("Tags")&&loadTags(dlg,options),-1!==options.visibleSettings.indexOf("OfficialRatings")&&loadOfficialRatings(dlg,options),-1!==options.visibleSettings.indexOf("Containers")&&loadContainers(dlg,options),-1!==options.visibleSettings.indexOf("Years")&&loadYears(dlg,options),-1!==options.visibleSettings.indexOf("AudioCodecs")&&loadAudioCodecs(dlg,options),-1!==options.visibleSettings.indexOf("VideoCodecs")&&loadVideoCodecs(dlg,options),-1!==options.visibleSettings.indexOf("SubtitleCodecs")&&loadSubtitleCodecs(dlg,options),bindCheckboxInput(dlg,!0),dlg.querySelector(".btnCancel").addEventListener("click",function(){dialogHelper.close(dlg)}),layoutManager.tv&&centerFocus(dlg.querySelector(".formDialogContent"),!1,!0);var submitted;dlg.querySelector("form").addEventListener("change",function(){submitted=!0},!0),dialogHelper.open(dlg).then(function(){if(bindCheckboxInput(dlg,!1),layoutManager.tv&&centerFocus(dlg.querySelector(".formDialogContent"),!1,!1),submitted)return saveValues(dlg,options.settings,options.settingsKey),void resolve();reject()})})})},FilterMenu});